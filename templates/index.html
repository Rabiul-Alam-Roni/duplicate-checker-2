<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Duplicate Checker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- (Optional) include Bootstrap CSS for styling -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" integrity="sha512-..." crossorigin="anonymous" />
</head>
<body class="p-4">
  <div class="container">
    <h1 class="mb-4">Duplicate Checker Tool</h1>

    <!-- Single Article Check Section -->
    <div class="mb-5 p-3 border rounded">
      <h3>Check a Single Article</h3>
      <p>Enter a DOI or article title to check if it's a duplicate:</p>
      <div class="input-group mb-3">
        <input type="text" id="articleInput" class="form-control" placeholder="Enter DOI or Title" />
        <button id="checkBtn" class="btn btn-primary">Check</button>
      </div>
      <div id="singleMessage" class="fw-bold"></div>
    </div>

    <!-- Bulk Upload Section -->
    <div class="mb-5 p-3 border rounded">
      <h3>Upload CSV/Excel for Batch Check</h3>
      <p>Select a CSV or XLSX file containing a list of articles. The tool will identify any duplicate entries within the file.</p>
      <div class="mb-3">
        <input type="file" id="fileInput" accept=".csv,.xlsx" class="form-control" />
      </div>
      <button id="uploadBtn" class="btn btn-secondary">Upload File</button>
      <div id="uploadMessage" class="fw-bold mt-2"></div>
    </div>

    <!-- Statistics Section -->
    <div class="mb-5 p-3 border rounded">
      <h3>Statistics</h3>
      <p>Total Articles: <span id="totalCount">0</span></p>
      <p>Duplicate Entries: <span id="dupCount">0</span></p>
    </div>

    <!-- Download Button -->
    <div class="mb-5">
      <button id="downloadBtn" class="btn btn-success" disabled>Download Results</button>
    </div>
  </div>

  <script>
    // Helper function to update the statistics display from the API
    async function updateStats() {
      try {
        const res = await fetch("/api/stats");
        if (!res.ok) return;
        const data = await res.json();
        document.getElementById("totalCount").textContent = data.total;
        document.getElementById("dupCount").textContent = data.duplicates;
      } catch (err) {
        console.error("Failed to update stats:", err);
      }
    }

    // Handle single article check
    document.getElementById("checkBtn").addEventListener("click", async () => {
      const query = document.getElementById("articleInput").value.trim();
      const msgDiv = document.getElementById("singleMessage");
      msgDiv.textContent = "";  // clear previous message
      if (!query) {
        msgDiv.textContent = "Please enter a DOI or title.";
        msgDiv.style.color = "red";
        return;
      }
      // Send request to check_article API
      try {
        const res = await fetch("/check_article", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ article: query })
        });
        const data = await res.json();
        if (!res.ok || data.error) {
          // If server returned an error
          msgDiv.textContent = "Error: " + (data.error || "Unknown error occurred");
          msgDiv.style.color = "red";
        } else {
          // Successful response
          if (data.duplicate) {
            msgDiv.textContent = "This article already exists (duplicate found).";
            msgDiv.style.color = "orange";
          } else {
            msgDiv.textContent = "No duplicate found. Article has been added to the list.";
            msgDiv.style.color = "green";
          }
          // Update stats display after check
          updateStats();
        }
      } catch (err) {
        console.error("Request failed:", err);
        msgDiv.textContent = "Error: Could not check the article.";
        msgDiv.style.color = "red";
      }
    });

    // Handle file upload
    document.getElementById("uploadBtn").addEventListener("click", async () => {
      const fileInput = document.getElementById("fileInput");
      const msgDiv = document.getElementById("uploadMessage");
      msgDiv.textContent = "";  // clear previous message
      if (!fileInput.files.length) {
        msgDiv.textContent = "Please select a file to upload.";
        msgDiv.style.color = "red";
        return;
      }
      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append("file", file);
      try {
        const res = await fetch("/upload_file", {
          method: "POST",
          body: formData
        });
        const data = await res.json();
        if (!res.ok || data.error) {
          // Upload error
          msgDiv.textContent = "Upload Error: " + (data.error || "File processing failed");
          msgDiv.style.color = "red";
        } else {
          // Success - display stats from response
          msgDiv.textContent = `Success! Processed ${data.total} articles, found ${data.duplicates} duplicate entries.`;
          msgDiv.style.color = "green";
          // Update stats section numbers
          document.getElementById("totalCount").textContent = data.total;
          document.getElementById("dupCount").textContent = data.duplicates;
          // Enable the download button now that results are available
          document.getElementById("downloadBtn").disabled = false;
        }
      } catch (err) {
        console.error("Upload request failed:", err);
        msgDiv.textContent = "Upload Error: File processing failed.";
        msgDiv.style.color = "red";
      }
    });

    // Handle download button click - trigger file download
    document.getElementById("downloadBtn").addEventListener("click", () => {
      // Navigate to /export to download the file
      window.location.href = "/export";
    });

    // Initial load: fetch current stats (should be zeros at start or persistent from last session if any)
    updateStats();
  </script>
</body>
</html>
