<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duplicate Checker for AI Bobby Team</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Styles as before, from your previous code. Keep or update as you wish. */
        /* ... use your own styles or keep what I posted before ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- Header and forms as before, see your posted HTML for details -->
        <!-- ... all your form and stats code ... -->
    </div>
    <script>
        // (Shortened for clarity: this is the correct checkDuplicate, uploadFile, and exportDatabase function)

        // Helper function to show responses
        function showResponse(element, type, message) {
            element.innerHTML = message;
            element.className = `response ${type}`;
            element.style.display = 'flex';
        }
        function clearForm() {
            document.getElementById('doi').value = '';
            document.getElementById('title').value = '';
            document.getElementById('protein').value = '';
            document.getElementById('hardness').checked = false;
            document.getElementById('whc').checked = false;
        }
        // Article checking function
        async function checkDuplicate() {
            const doi = document.getElementById('doi').value.trim();
            const title = document.getElementById('title').value.trim();
            const protein = document.getElementById('protein').value.trim();
            const hardness = document.getElementById('hardness').checked;
            const whc = document.getElementById('whc').checked;
            const loading = document.getElementById('loading');
            const response = document.getElementById('response');

            if (!doi) {
                showResponse(response, 'error', '<i class="fas fa-exclamation-triangle"></i> Please enter a DOI');
                return;
            }

            loading.style.display = 'block';
            response.style.display = 'none';

            try {
                const formData = new FormData();
                formData.append('doi', doi);
                formData.append('title', title);
                formData.append('protein_name', protein);
                formData.append('hardness', hardness ? 'true' : '');
                formData.append('whc', whc ? 'true' : '');

                const result = await fetch('/check_article', {
                    method: 'POST',
                    body: formData
                });

                const data = await result.json();
                
                if (result.ok) {
                    if (data.status === 'duplicate') {
                        showResponse(response, 'duplicate', `<i class="fas fa-exclamation-circle"></i> ${data.message}`);
                    } else if (data.status === 'success') {
                        showResponse(response, 'success', `<i class="fas fa-check-circle"></i> ${data.message}`);
                        clearForm();
                    } else {
                        showResponse(response, 'error', `<i class="fas fa-times-circle"></i> ${data.message}`);
                    }
                } else {
                    showResponse(response, 'error', `<i class="fas fa-times-circle"></i> Error: ${data.message || 'Unknown error'}`);
                }
            } catch (error) {
                showResponse(response, 'error', `<i class="fas fa-exclamation-triangle"></i> Network Error: ${error.message}`);
            } finally {
                loading.style.display = 'none';
            }
        }
        async function uploadFile() {
            const fileInput = document.getElementById('fileUpload');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const fileResponse = document.getElementById('fileResponse');

            if (fileInput.files.length === 0) {
                showResponse(fileResponse, 'error', '<i class="fas fa-exclamation-triangle"></i> Please select a CSV or Excel file');
                return;
            }

            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);

            progressBar.style.display = 'block';
            progressFill.style.width = '0%';
            fileResponse.style.display = 'none';

            try {
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 30;
                    if (progress > 90) progress = 90;
                    progressFill.style.width = progress + '%';
                }, 200);

                const result = await fetch('/upload_file', {
                    method: 'POST',
                    body: formData
                });

                clearInterval(progressInterval);
                progressFill.style.width = '100%';

                const data = await result.json();
                
                if (result.ok) {
                    showResponse(fileResponse, 'success', `<i class="fas fa-check-circle"></i> ${data.message}`);
                } else {
                    showResponse(fileResponse, 'error', `<i class="fas fa-times-circle"></i> Upload Error: ${data.detail || 'File processing failed'}`);
                }
            } catch (error) {
                showResponse(fileResponse, 'error', `<i class="fas fa-exclamation-triangle"></i> Upload Error: ${error.message}`);
            } finally {
                setTimeout(() => {
                    progressBar.style.display = 'none';
                    progressFill.style.width = '0%';
                }, 1000);
            }
        }
        async function exportDatabase() {
            try {
                showResponse(document.getElementById('fileResponse'), 'info', '<i class="fas fa-spinner fa-spin"></i> Preparing database export...');
                const response = await fetch('/export', { method: 'GET' });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `research_database_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showResponse(document.getElementById('fileResponse'), 'success', '<i class="fas fa-download"></i> Database successfully exported');
                } else {
                    const errorData = await response.json();
                    showResponse(document.getElementById('fileResponse'), 'error', `<i class="fas fa-times-circle"></i> Export failed: ${errorData.detail || 'Unknown error'}`);
                }
            } catch (error) {
                showResponse(document.getElementById('fileResponse'), 'error', `<i class="fas fa-exclamation-triangle"></i> Export Error: ${error.message}`);
            }
        }
        async function showStats() {
            const statsGrid = document.getElementById('statsGrid');
            try {
                const response = await fetch('/api/stats', { method: 'GET' });
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalArticles').textContent = stats.total_articles || 0;
                    document.getElementById('duplicatesFound').textContent = stats.duplicate_articles || 0;
                    document.getElementById('uniqueArticles').textContent = stats.unique_articles || 0;
                    document.getElementById('withHardness').textContent = stats.hardness_articles || 0;
                    document.getElementById('withWHC').textContent = stats.whc_articles || 0;
                    statsGrid.style.display = 'grid';
                } else {
                    showResponse(document.getElementById('fileResponse'), 'error', '<i class="fas fa-times-circle"></i> Failed to load statistics');
                }
            } catch (error) {
                showResponse(document.getElementById('fileResponse'), 'error', `<i class="fas fa-exclamation-triangle"></i> Stats Error: ${error.message}`);
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('doi').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') checkDuplicate();
            });
        });
        window.checkDuplicate = checkDuplicate;
        window.uploadFile = uploadFile;
        window.exportDatabase = exportDatabase;
        window.showStats = showStats;
    </script>
</body>
</html>
